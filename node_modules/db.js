var mysql=require('mysql');
var settings=require('settings.js');
var fs=require('fs');
var express=require('express');
var busboy = require('connect-busboy');
var bodyParser = require('body-parser');
var connection=mysql.createConnection({host:settings.mysql.host,port:settings.mysql.port,database:settings.mysql.database,user:settings.mysql.user,password:settings.mysql.password});
exports.userLogin=function(req,res,next){
    var info=req.body;
    connection.query('SELECT * FROM user WHERE ? ',{username:info.username},function(err,result){
        if(err) throw (err);
        else{
            if(result[0].password==req.body.password){
                req.flash('Successful user login!');
                connection.query('SELECT * FROM course WHERE ?',{publisherName:req.body.username},function(err,result){
                    if(err) throw(err);
                    res.render('user',{courseMy:result,username:info.username});
                })
            }else{
                req.flash('Not logged in!');
                res.end('Not logged in!');
            }
            }
    })
}
//查找最近更新
exports.videoAll=function(req,res,next){
    connection.query('SELECT * FROM course',function(err,result){
        if(err) throw(err);
        res.render('index',{videoAll:result});
    })
}
//查找某一门课程信息
exports.courseInfo=function(req,res,next){
    connection.query('SELECT * FROM course WHERE ?',{courseName:req.params.courseName},function(err,result){
        if(err) throw(err);
        fs.readdir('./public/files/'+result[0].courseName+'/courseware',function(err,files){
            if(err) throw (err);
            else{
                res.render('course',{courseInfo:result[0],coursewareUrl:files});
            }
        })
    })
}
//发布信息所做操作，以后需要细化
exports.publish=function(req,res,next){
    connection.query('SELECT * FROM course WHERE ?',{courseName:req.body.courseName},function(err,result){
        if(result[0]){
            res.send('<script>alert("course name already exists!")</script>');
            res.end();
        }else{
            connection.query('INSERT INTO course SET ?',{
                courseName:req.body.courseName,
                teacherName:req.body.teacherName,
                updateTime:new Date(),
                url:'http://122.0.72.205:3000/files/'+req.body.courseName+'/video/'+req.body.courseName+'.mp4',//此url为视频地址
                courseDes:req.body.courseDes,
                teacherDes:req.body.teacherDes,
                publisherName:req.params.username,
            },function(err,result){
                if(err) throw(err);
                else{
                    console.log('new course!');
                    var path='./public/files/'+req.body.courseName;
                    fs.exists(path,function(exists){
                        if(exists){

                        }else{
                            fs.mkdirSync(path);
                            fs.mkdirSync(path+'/video');
                            fs.mkdirSync(path+'/courseware');
                            res.render('upload',{courseName:req.body.courseName,username:req.params.username});
                        }
                    })
                }
            });
        }

    })
}

exports.saveFile=function(req,res,next){
    var path='./public/files/'+req.params.coursename;
    var fstream;
    req.pipe(req.busboy);
    req.busboy.on('file', function (fieldname, file, filename) {
        var patten=/.+\.mp4/;
        if(patten.test(filename)){
            var pathVideo=path+'/video/'+ req.params.coursename+'.mp4';
            fs.exists(pathVideo,function(exists){
                if(exists){
                    fs.unlinkSync(pathVideo);
                }
                else{}
            })
            console.log("Uploading: " + filename);
            console.log(path+'/video/'+ req.params.coursename+'.mp4')
            fstream = fs.createWriteStream(path+'/video/'+ req.params.coursename+'.mp4');
            file.pipe(fstream);
            fstream.on('close', function () {
                 res.end();
            });
        }else{
            var pathCourseware=path+'/courseware/'+ filename;
            fs.exists(pathCourseware,function(exists){
                if(exists){
                    fs.unlinkSync(pathCourseware);
                }
                else{}
            })
            console.log("Uploading: " + filename);
            fstream = fs.createWriteStream(path+'/courseware/'+ filename);
            file.pipe(fstream);
            fstream.on('close', function () {
                res.end();
            });
            
        };
    });
}

exports.editFile=function(req,res,next){
    var path='./public/files/'+req.params.coursename;
    console.log(path)
    fs.readdir(path+'/video',function(err,fileV){
        if(err) throw (err)
        else{
            console.log(fileV);
            fs.readdir(path+'/courseware',function(err,fileC){
                if(err) throw (err);
                else{
                    console.log(fileC)
                    res.render('addFile',{courseName:req.params.coursename,username:req.params.username,uploadedVideo:fileV[0],uploadedCourseware:fileC})
                }
            })
        }
    })
}
